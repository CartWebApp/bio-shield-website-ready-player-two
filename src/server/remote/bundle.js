class e extends Error{constructor(e,t){super(e),this.name="DevalueError",this.path=t.join("")}}function t(e){return Object(e)!==e}const r=Object.getOwnPropertyNames(Object.prototype).sort().join("\0");function n(e){switch(e){case'"':return'\\"';case"<":return"\\u003C";case"\\":return"\\\\";case"\n":return"\\n";case"\r":return"\\r";case"\t":return"\\t";case"\b":return"\\b";case"\f":return"\\f";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:return e<" "?`\\u${e.charCodeAt(0).toString(16).padStart(4,"0")}`:""}}function a(e){let t="",r=0;const a=e.length;for(let o=0;o<a;o+=1){const a=n(e[o]);a&&(t+=e.slice(r,o)+a,r=o+1)}return`"${0===r?e:t+e.slice(r)}"`}const o=/^[a-zA-Z_$][a-zA-Z_$0-9]*$/;function s(e){return o.test(e)?"."+e:"["+JSON.stringify(e)+"]"}function c(e){const t=new DataView(e);let r="";for(let n=0;n<e.byteLength;n++)r+=String.fromCharCode(t.getUint8(n));return function(e){let t="";for(let r=0;r<e.length;r+=3){const n=[void 0,void 0,void 0,void 0];n[0]=e.charCodeAt(r)>>2,n[1]=(3&e.charCodeAt(r))<<4,e.length>r+1&&(n[1]|=e.charCodeAt(r+1)>>4,n[2]=(15&e.charCodeAt(r+1))<<2),e.length>r+2&&(n[2]|=e.charCodeAt(r+2)>>6,n[3]=63&e.charCodeAt(r+2));for(let e=0;e<n.length;e++)void 0===n[e]?t+="=":t+=u[n[e]]}return t}(r)}function i(e){const t=function(e){e.length%4==0&&(e=e.replace(/==?$/,""));let t="",r=0,n=0;for(let a=0;a<e.length;a++)r<<=6,r|=u.indexOf(e[a]),n+=6,24===n&&(t+=String.fromCharCode((16711680&r)>>16),t+=String.fromCharCode((65280&r)>>8),t+=String.fromCharCode(255&r),r=n=0);12===n?(r>>=4,t+=String.fromCharCode(r)):18===n&&(r>>=2,t+=String.fromCharCode((65280&r)>>8),t+=String.fromCharCode(255&r));return t}(e),r=new ArrayBuffer(t.length),n=new DataView(r);for(let e=0;e<r.byteLength;e++)n.setUint8(e,t.charCodeAt(e));return r}const u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function f(e,t){return function(e){if("number"==typeof e)return n(e,!0);if(!Array.isArray(e)||0===e.length)throw new Error("Invalid input");const t=e,r=Array(t.length);function n(e,a=!1){if(-1===e)return;if(-3===e)return NaN;if(-4===e)return 1/0;if(-5===e)return-1/0;if(-6===e)return-0;if(a||"number"!=typeof e)throw new Error("Invalid input");if(e in r)return r[e];const o=t[e];if(o&&"object"==typeof o)if(Array.isArray(o))if("string"==typeof o[0]){const t=o[0];switch(t){case"Date":r[e]=new Date(o[1]);break;case"Set":const a=new Set;r[e]=a;for(let e=1;e<o.length;e+=1)a.add(n(o[e]));break;case"Map":const s=new Map;r[e]=s;for(let e=1;e<o.length;e+=2)s.set(n(o[e]),n(o[e+1]));break;case"RegExp":r[e]=new RegExp(o[1],o[2]);break;case"Object":r[e]=Object(o[1]);break;case"BigInt":r[e]=BigInt(o[1]);break;case"null":const c=Object.create(null);r[e]=c;for(let e=1;e<o.length;e+=2)c[o[e]]=n(o[e+1]);break;case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"BigInt64Array":case"BigUint64Array":{const a=new(0,globalThis[t])(n(o[1]));r[e]=void 0!==o[2]?a.subarray(o[2],o[3]):a;break}case"ArrayBuffer":{const t=i(o[1]);r[e]=t;break}case"Temporal.Duration":case"Temporal.Instant":case"Temporal.PlainDate":case"Temporal.PlainTime":case"Temporal.PlainDateTime":case"Temporal.PlainMonthDay":case"Temporal.PlainYearMonth":case"Temporal.ZonedDateTime":{const n=t.slice(9);r[e]=Temporal[n].from(o[1]);break}case"URL":{const t=new URL(o[1]);r[e]=t;break}case"URLSearchParams":{const t=new URLSearchParams(o[1]);r[e]=t;break}default:throw new Error(`Unknown type ${t}`)}}else{const t=new Array(o.length);r[e]=t;for(let e=0;e<o.length;e+=1){const r=o[e];-2!==r&&(t[e]=n(r))}}else{const t={};r[e]=t;for(const e in o){if("__proto__"===e)throw new Error("Cannot parse an object with a `__proto__` property");const r=o[e];t[e]=n(r)}}else r[e]=o;return r[e]}return n(0)}(JSON.parse(e))}function l(n,o){const i=[],u=new Map,f=[],l=[];let y=0;const p=function n(o){if("function"==typeof o)throw new e("Cannot stringify a function",l);if(void 0===o)return-1;if(Number.isNaN(o))return-3;if(o===1/0)return-4;if(o===-1/0)return-5;if(0===o&&1/o<0)return-6;if(u.has(o))return u.get(o);const p=y++;u.set(o,p);for(const{key:e,fn:t}of f){const r=t(o);if(r)return i[p]=`["${e}",${n(r)}]`,p}let h="";if(t(o))h=g(o);else{const i=function(e){return Object.prototype.toString.call(e).slice(8,-1)}(o);switch(i){case"Number":case"String":case"Boolean":h=`["Object",${g(o)}]`;break;case"BigInt":h=`["BigInt",${o}]`;break;case"Date":h=`["Date","${!isNaN(o.getDate())?o.toISOString():""}"]`;break;case"URL":h=`["URL",${a(o.toString())}]`;break;case"URLSearchParams":h=`["URLSearchParams",${a(o.toString())}]`;break;case"RegExp":const{source:u,flags:f}=o;h=f?`["RegExp",${a(u)},"${f}"]`:`["RegExp",${a(u)}]`;break;case"Array":h="[";for(let e=0;e<o.length;e+=1)e>0&&(h+=","),e in o?(l.push(`[${e}]`),h+=n(o[e]),l.pop()):h+=-2;h+="]";break;case"Set":h='["Set"';for(const e of o)h+=`,${n(e)}`;h+="]";break;case"Map":h='["Map"';for(const[e,r]of o)l.push(`.get(${t(e)?g(e):"..."})`),h+=`,${n(e)},${n(r)}`,l.pop();h+="]";break;case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"BigInt64Array":case"BigUint64Array":{const e=o;h='["'+i+'",'+n(e.buffer);const t=o.byteOffset,r=t+o.byteLength;if(t>0||r!==e.buffer.byteLength){const e=+/(\d+)/.exec(i)[1]/8;h+=`,${t/e},${r/e}`}h+="]";break}case"ArrayBuffer":h=`["ArrayBuffer","${c(o)}"]`;break;case"Temporal.Duration":case"Temporal.Instant":case"Temporal.PlainDate":case"Temporal.PlainTime":case"Temporal.PlainDateTime":case"Temporal.PlainMonthDay":case"Temporal.PlainYearMonth":case"Temporal.ZonedDateTime":h=`["${i}",${a(o.toString())}]`;break;default:if(!function(e){const t=Object.getPrototypeOf(e);return t===Object.prototype||null===t||null===Object.getPrototypeOf(t)||Object.getOwnPropertyNames(t).sort().join("\0")===r}(o))throw new e("Cannot stringify arbitrary non-POJOs",l);if((b=o,Object.getOwnPropertySymbols(b).filter(e=>Object.getOwnPropertyDescriptor(b,e).enumerable)).length>0)throw new e("Cannot stringify POJOs with symbolic keys",l);if(null===Object.getPrototypeOf(o)){h='["null"';for(const e in o)l.push(s(e)),h+=`,${a(e)},${n(o[e])}`,l.pop();h+="]"}else{h="{";let e=!1;for(const t in o)e&&(h+=","),e=!0,l.push(s(t)),h+=`${a(t)}:${n(o[t])}`,l.pop();h+="}"}}}var b;return i[p]=h,p}(n);return p<0?`${p}`:`[${i.join(",")}]`}function g(e){const t=typeof e;return"string"===t?a(e):e instanceof String?a(e.toString()):void 0===e?(-1).toString():0===e&&1/e<0?(-6).toString():"bigint"===t?`["BigInt","${e}"]`:String(e)}const y=new Map,p=new Map,h=new Map,b=new Set;function d(e,t,r){if("string"!=typeof e)throw new Error("remote functions must be exported");y.has(t)||y.set(t,new Map);const n=y.get(t);return a=>{const o=n.get(a);if("object"==typeof o)return o.query;let s,c,i=!1,u=!0;const g=()=>new Promise(async(n,o)=>{u=!0;try{n(s=await(async()=>{const n={argument:l(a)},o=await fetch(e,{method:"POST",headers:{"Content-Type":"text/plain",remote_function:l([t,r])},body:JSON.stringify(n)}),s=await o.json();if(s.success)return f(s.result);throw f(s.error)})()),c=void 0}catch(e){o(c=e)}u=!1,i=!0});g().catch(()=>{});const y={get then(){const e=g();return e.then.bind(e)},get catch(){const e=g();return e.catch.bind(e)},get finally(){const e=g();return e.finally.bind(e)},get error(){return c},get loading(){return u},get ready(){return i},get current(){return s},set(e){s=e,u=!1,i=!0,c=void 0},refresh:()=>g().then(()=>{},()=>{}),withOverride(e){const r=s;s=e(s);const n={release(){s=r}};return h.set(n,{key:t,arg:a}),n}};return n.set(a,{query:y,set(e){s=e.current,c=e.error}}),p.set(y,{key:t,arg:a}),y}}function m(e,t,r){if("string"!=typeof t)throw new Error("remote functions must be exported");const n=n=>{let a;const o=()=>s=new Promise(async(o,s)=>{const c={key:t,arg:n};b.add(c);try{o(await(async()=>{const o={argument:l(n),queries:"object"==typeof a?a.map(({key:e,arg:t})=>({key:e,argument:l(t)})):[...p.values()].map(({key:e,arg:t})=>({key:e,argument:l(t)}))},s=await fetch(e,{method:"POST",headers:{"Content-Type":"text/plain",remote_function:l([t,r])},body:JSON.stringify(o)}),c=await s.json(),{queries:i}=c;if("object"==typeof i)for(const e of i){const t=y.get(e.key);if(void 0===t)continue;const r=t.get(f(e.argument));void 0!==r&&r.set({current:f(c.result),error:f(c.error)})}if(c.success)return f(c.result);throw f(c.error)})())}catch(e){s(e)}a=void 0,b.delete(c)});let s;const c={get then(){const e=o();return e.then.bind(e)},get catch(){const e=o();return e.catch.bind(e)},get finally(){const e=o();return e.finally.bind(e)},updates(...e){a=[];const t=[];for(const r of e)"release"in r?t.push(h.get(r)):t.push(p.get(r));return a=t,s}};return c};return Object.defineProperty(n,"pending",{get:()=>[...b].filter(({key:e})=>e===t).length}),n}export{m as command,d as query};
